version: '3.8'

services:
  # --- Cluster de Servidores do Jogo ---
  server-1:
    build:
      context: .
      dockerfile: server/Dockerfile
    image: pingpong-server:latest
    container_name: pbl_server_1
    hostname: server-1
    networks:
      - game-net
    ports:
      - "9000:9000"
      - "8000:8000"
    # ADIÇÃO: Carrega as variáveis do arquivo .env
    env_file:
      - .env
    environment:
      - LISTEN_ADDR=:9000
      - API_ADDR=:8000
      - ALL_SERVERS=http://server-1:8000,http://server-2:8000,http://server-3:8000

  server-2:
    build:
      context: .
      dockerfile: server/Dockerfile
    image: pingpong-server:latest
    container_name: pbl_server_2
    hostname: server-2
    networks:
      - game-net
    ports:
      - "9001:9000"
      - "8001:8000"
    # ADIÇÃO
    env_file:
      - .env
    environment:
      - LISTEN_ADDR=:9000
      - API_ADDR=:8000
      - ALL_SERVERS=http://server-1:8000,http://server-2:8000,http://server-3:8000

  server-3:
    build:
      context: .
      dockerfile: server/Dockerfile
    image: pingpong-server:latest
    container_name: pbl_server_3
    hostname: server-3
    networks:
      - game-net
    ports:
      - "9002:9000"
      - "8002:8000"
    # ADIÇÃO
    env_file:
      - .env
    environment:
      - LISTEN_ADDR=:9000
      - API_ADDR=:8000
      - ALL_SERVERS=http://server-1:8000,http://server-2:8000,http://server-3:8000

  # ... (mantenha o client e blockchain-node como estão) ...
  blockchain-node:
    # ... mantenha a configuração que já fizemos (imagem, volumes, ports) ...
    build:
      context: ./blockchain
      dockerfile: Dockerfile
    container_name: pbl_blockchain
    networks:
      - game-net
    ports:
      - "8545:8545"
      - "30303:30303"
    volumes:
      - ./blockchain_data:/root/.ethereum

  client:
    # ... (sem alterações necessárias aqui) ...
    build:
      context: .
      dockerfile: client/Dockerfile
    image: pingpong-client:latest
    stdin_open: true
    tty: true
    networks:
      - game-net
    environment:
      SERVER_ADDR: "server-1:9000"
      PING_INTERVAL_MS: "2000"
    depends_on:
      - server-1

networks:
  game-net:
    driver: bridge